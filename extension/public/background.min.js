async function getMember(e){try{const a=await fetch(e,{method:"GET",headers:{"Content-Type":"application/json"}});if(!a.ok)throw new Error("Network response was not ok");return await a.json()}catch(e){return e}}function fetchTabs(e){return new Promise(((a,s)=>{chrome.tabs.query(e,(e=>{chrome.runtime.lastError?s(new Error(chrome.runtime.lastError)):a(e)}))}))}const prepareMessage=async()=>{try{const e=await fetchTabs({url:"https://*.facebook.com/*"});if(0===e.length)return void console.log("No active tabs found");const a=e[0].id,s=await chrome.storage.local.get("uids");if(!s.uids)return chrome.tabs.sendMessage(a,{action:"error",message:"Please upload list of uids!"}),void chrome.alarms.clear("interval");const r=await chrome.storage.local.get("uidsCounter"),t=await chrome.storage.local.get("uidsLength"),o=await chrome.storage.local.get("messages");if(!o.messages)return chrome.tabs.sendMessage(a,{action:"error",message:"Please upload messages!"}),void chrome.alarms.clear("interval");const c=await chrome.storage.local.get("messagesCounter"),n=o.messages[c.messagesCounter],i=s.uids[r.uidsCounter],m=t.uidsLength,l=`https://www.facebook.com/messages/t/${i}`;if(r.uidsCounter>=m)return chrome.alarms.clear("interval"),void chrome.tabs.sendMessage(a,{action:"error",message:"Please upload new list of uids!"});let u={};chrome.tabs.onUpdated.addListener((async(e,a,s)=>{if("complete"===a.status){u[e]&&(!function(e){chrome.alarms.clear("checkInputAlarm",(()=>{chrome.alarms.create("checkInputAlarm",{periodInMinutes:.083})})),chrome.alarms.onAlarm.addListener((a=>{"checkInputAlarm"===a.name&&chrome.tabs.sendMessage(e,{action:"checkInput"},(async a=>{a&&"found"===a.status&&(chrome.alarms.clear("checkInputAlarm"),chrome.tabs.sendMessage(e,{action:"time",message:n,count:r.uidsCounter+1}),r.uidsCounter>=m-1&&(chrome.alarms.clear("interval"),chrome.tabs.sendMessage(e,{action:"ended",count:`Finished @${r.uidsCounter+1}`})),c.messagesCounter===o.messages.length-1?await chrome.storage.local.set({messagesCounter:0}):await chrome.storage.local.set({messagesCounter:c.messagesCounter+1}),await chrome.storage.local.set({uidsCounter:r.uidsCounter+1}))}))}))}(e),delete u[e]);const a=await fetchTabs({url:"https://*.facebook.com/*"});a.length>1&&a.slice(1).forEach((e=>{chrome.tabs.sendMessage(e.id,{action:"warning"})}))}})),function(e,a){u[e]=!0,chrome.tabs.update(e,{url:a})}(a,l)}catch(e){console.error("Error fetching active tab",e.message)}};chrome.runtime.onMessage.addListener((async(e,a,s)=>{"start"===e.action&&(chrome.alarms.clear("interval"),await prepareMessage(),chrome.alarms.create("interval",{periodInMinutes:20})),"pause"===e.action&&chrome.alarms.clear("interval")})),chrome.alarms.onAlarm.addListener((async e=>{if("interval"===e.name){const e=`https://api.socialwarlock.com/api/v1/messenger/get-member/${(await chrome.storage.local.get("key")).key}`,a=await getMember(e);"success"===a.status&&a.data.member.credit>=1?await prepareMessage():chrome.alarms.clear("interval")}}));